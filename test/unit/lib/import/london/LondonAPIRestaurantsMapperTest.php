<?php
require_once 'PHPUnit/Framework.php';
require_once dirname( __FILE__ ) . '/../../../../../test/bootstrap/unit.php';
require_once dirname( __FILE__ ) . '/../../../bootstrap.php';

/**
 * Test class for LondonAPIRestaurantsMapper.
 * Generated by PHPUnit on 2010-02-08 at 13:02:30.
 */
class LondonAPIRestaurantsMapperTest extends PHPUnit_Framework_TestCase
{
  /**
   * @var LondonAPIRestaurantsMapper
   */
  protected $object;

  /**
   * @var
   */
  protected $numVenuesInFixture = 10;

  /**
   * Sets up the fixture, for example, opens a network connection.
   * This method is called before a test is executed.
   */
  protected function setUp()
  {
    ProjectN_Test_Unit_Factory::createDatabases();

    $vendor = new Vendor();
    $vendor['city'] = 'london';
    $vendor['language'] = 'en-GB';
    $vendor->save();

    $geoEncoder = $this->getMock('geoEncode', array( 'setAddress', 'getLongitude', 'getLatitude' ) );
    $geoEncoder->expects( $this->exactly( $this->numVenuesInFixture ) )
               ->method( 'setAddress' );

    $geoEncoder->expects( $this->exactly( $this->numVenuesInFixture ) )
               ->method( 'getLongitude' )
               ->will( $this->returnValue( 1.1 ) );

    $geoEncoder->expects( $this->exactly( $this->numVenuesInFixture ) )
               ->method( 'getLatitude' )
               ->will( $this->returnValue( 2.2 ) );

    $this->object = new LondonAPIRestaurantsMapper( $geoEncoder );
  }

  /**
   * Tears down the fixture, for example, closes a network connection.
   * This method is called after a test is executed.
   */
  protected function tearDown()
  {
    ProjectN_Test_Unit_Factory::destroyDatabases();
  }

  public function testMapPoi()
  {
    $importer = new Importer();
    $importer->addDataMapper( $this->object );
    $importer->run();
    
    $poiResults = Doctrine::getTable('Poi')->findAll();
    $this->assertEquals(10, $poiResults->count() );

    $poi = $poiResults[0];

    $this->assertFalse( empty( $poi[ 'vendor_id' ] ) );
    $this->assertFalse( empty( $poi[ 'vendor_poi_id' ] ),     'vendor_poi_id should not be empty' );
    $this->assertFalse( empty( $poi[ 'street' ] ),            'street should not be empty' );
    $this->assertFalse( empty( $poi[ 'city' ] ),              'city should not be empty' );
    $this->assertFalse( empty( $poi[ 'country' ] ),           'city should not be empty' );
    $this->assertFalse( empty( $poi[ 'longitude' ] ) );
    $this->assertFalse( empty( $poi[ 'latitude' ] ) );
    $this->assertFalse( empty( $poi[ 'poi_name' ] ),          'poi_name should not be empty' );
    $this->assertFalse( empty( $poi[ 'url' ] ),               'url should not be empty' );
    $this->assertFalse( empty( $poi[ 'phone' ] ),             'phone should not be empty' );
    $this->assertFalse( empty( $poi[ 'zips' ] ),              'zips should not be empty' );
    $this->assertFalse( empty( $poi[ 'price_information' ] ), 'price_information should not be empty' );
    $this->assertFalse( empty( $poi[ 'openingtimes' ] ),      'openingtimes should not be empty' );
    $this->assertFalse( empty( $poi[ 'star_rating' ] ),       'star_rating should not be empty' );
    $this->assertFalse( empty( $poi[ 'description' ] ),       'description should not be empty' );

    $this->assertGreaterThan( 0, count( $poi['PoiProperty'] ) );
  }
}
?>
